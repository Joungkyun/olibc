# $Id: Makefile.in,v 1.14 2004-02-18 16:33:27 oops Exp $
PROG		= @PACKAGE_NAME@
VERSION		= @PACKAGE_VERSION@
AR		= @AR@
CC		= @CC@ -Wall
CFLAGS		= @CFLAGS@ -fpic
CPPFLAGS	= -I. -Ipcrelib -Ilibidn @CPPFLAGS@
LDFLAGS		= @LIBS@ @LDFLAGS@
LIBS		= @LIBS@
DEFS		= @DEFS@ $(CPPFLAGS)
OBJECT		= libmisc.o libidn.o libstring.o libpcre.o libfile.o libtime.o libarg.o _race.o
PCREOBJ		= pcrelib/get.o pcrelib/maketables.o pcrelib/pcre.o pcrelib/study.o
IDNOBJ		= libidn/idna.o libidn/nfkc.o libidn/profiles.o libidn/punycode.o \
		  libidn/stringprep.o libidn/rfc3454.o libidn/toutf8.o
OBOBJ		= libmisc.o libstring.o libpcre.o libfile.o libtime.o libarg.o
OGOBJ		= libstring.o libmisc.o _race.o libidn.o
OLDSO		= lib$(PROG).so.0.0.8

SONAME_MAJOR	= @SONAME_MAJOR@

SONAME		= lib$(PROG).so.$(SONAME_MAJOR)
SBNAME		= liboc.so.$(SOMANE_MAJOR)
SGNAME		= libogc.so.$(SOMANE_MAJOR)
DESTDIR		=

prefix		= @prefix@
exec_prefix	= @exec_prefix@
datadir		= @datadir@
includedir	= @includedir@
libdir		= @libdir@
bindir		= @bindir@

INSTALL		= @INSTALL@
RM		= @RM@ -f
MAKE		= @MAKE@
MKDIR		= @MKDIR@ -p
STRIP		= @STRIP@
LN		= @LN_S@
MV		= @MV@
CP		= @CP@
PERL		= @PERL@

all: pcre idn $(OBJECT) staticlib sharedlib olibc-config

libmisc.o: libmisc.c olibc-config.h common.h
	$(CC) $(CFLAGS) $(DEFS) -c $<

libidn.o: libidn.c libidn.h olibc-config.h common.h
	$(CC) $(CFLAGS) $(DEFS) -c $<

libpcre.o: libpcre.c libpcre.h olibc-config.h common.h
	$(CC) $(CFLAGS) $(DEFS) -c $<

libstring.o: libstring.c libstring.h olibc-config.h common.h
	$(CC) $(CFLAGS) $(DEFS) -c $<

libfile.o: libfile.c libfile.h olibc-config.h common.h
	$(CC) $(CFLAGS) $(DEFS) -c $<

libtime.o: libtime.c libtime.h olibc-config.h common.h
	$(CC) $(CFLAGS) $(DEFS) -c $<

libarg.o: libarg.c libarg.h olibc-config.h common.h
	$(CC) $(CFLAGS) $(DEFS) -c $<

_race.o: _race.c _race.h olibc-config.h common.h
	$(CC) $(CFLAGS) $(DEFS) -c $<

pcre:
	$(MAKE) -C pcrelib

idn:
	$(MAKE) -C libidn

staticlib:
	$(AR) rcs lib$(PROG).a $(OBJECT) $(PCREOBJ) $(IDNOBJ)
	$(AR) rcs liboc.a $(OBOBJ) $(PCREOBJ)
	$(AR) rcs libogc.a $(OGOBJ) $(IDNOBJ)

sharedlib:
	$(CC) -shared -Wl,-soname,$(SONAME) -o lib$(PROG).so.$(VERSION) $(OBJECT) $(PCREOBJ) $(IDNOBJ)
	$(CC) -shared -Wl,-soname,$(SBNAME) -o liboc.so.$(VERSION) $(OBOBJ) $(PCREOBJ) $(IDNOBJ)
	$(CC) -shared -Wl,-soname,$(SGNAME) -o libogc.so.$(VERSION) $(OGOBJ) $(IDNOBJ)
	# for compotable old version
	$(CC) -shared -Wl,-soname,$(OLDSO) -o lib$(PROG).so.0.0.8 $(OBJECT) $(PCREOBJ) $(IDNOBJ)

olibc-config:
	$(CP) -f olibc-config.in olibc-config
	$(PERL) -pi -e "s!\@prefix\@!$(prefix)!g" olibc-config
	$(PERL) -pi -e "s!\@exec_prefix\@!$(exec_prefix)!g" olibc-config
	$(PERL) -pi -e "s!\@VERSION\@!$(VERSION)!g" olibc-config
	$(PERL) -pi -e "s!\@includedir\@!$(includedir)!g" olibc-config
	$(PERL) -pi -e "s!\@libdir\@!$(libdir)!g" olibc-config
	$(PERL) -pi -e "s!\@LIBS\@!$(LIBS)!g" olibc-config

install: install-doc install-header
	$(MKDIR) $(DESTDIR)$(bindir)
	$(INSTALL) -m755 olibc-config $(DESTDIR)$(bindir)

	$(MKDIR) $(DESTDIR)$(libdir)
	$(LN) lib$(PROG).so.$(VERSION) lib$(PROG).so
	$(LN) lib$(PROG).so.$(VERSION) $(SONAME)
	$(LN) liboc.so.$(VERSION) liboc.so
	$(LN) liboc.so.$(VERSION) $(SBNAME)
	$(LN) libogc.so.$(VERSION) libogc.so
	$(LN) libogc.so.$(VERSION) $(SGNAME)

	$(MV) lib$(PROG).so $(DESTDIR)$(libdir)
	$(MV) $(SONAME) $(DESTDIR)$(libdir)
	$(MV) liboc.so $(DESTDIR)$(libdir)
	$(MV) $(SBNAME) $(DESTDIR)$(libdir)
	$(MV) libogc.so $(DESTDIR)$(libdir)
	$(MV) $(SGNAME) $(DESTDIR)$(libdir)

	$(INSTALL) -m 755 lib$(PROG).so.$(VERSION) $(DESTDIR)$(libdir)
	$(INSTALL) -m 755 liboc.so.$(VERSION) $(DESTDIR)$(libdir)
	$(INSTALL) -m 755 libogc.so.$(VERSION) $(DESTDIR)$(libdir)
	$(INSTALL) -m 644 lib$(PROG).a $(DESTDIR)$(libdir)
	$(INSTALL) -m 644 liboc.a $(DESTDIR)$(libdir)
	$(INSTALL) -m 644 libogc.a $(DESTDIR)$(libdir)

	# for compotable old version
	$(INSTALL) -m 755 lib$(PROG).so.0.0.8 $(DESTDIR)$(libdir)


install-header:
	$(MKDIR) $(DESTDIR)$(includedir)/olibc
	$(INSTALL) -m 644 olibc-config.h $(DESTDIR)$(includedir)/olibc/
	$(INSTALL) -m 644 common.h $(DESTDIR)$(includedir)/olibc/
	$(INSTALL) -m 644 libfile.h $(DESTDIR)$(includedir)/olibc/
	$(INSTALL) -m 644 libpcre.h $(DESTDIR)$(includedir)/olibc/
	$(INSTALL) -m 644 libstring.h $(DESTDIR)$(includedir)/olibc/
	$(INSTALL) -m 644 libtime.h $(DESTDIR)$(includedir)/olibc/
	$(INSTALL) -m 644 libarg.h $(DESTDIR)$(includedir)/olibc/
	$(INSTALL) -m 644 libidn.h $(DESTDIR)$(includedir)/olibc/

install-doc:
	$(MAKE) -C man install

clean:
	$(MAKE) -C pcrelib clean
	$(MAKE) -C libidn clean
	-$(RM) -f *.o *.so* *.a main olibc-config

distclean: clean
	-$(RM) -f olibc-config.h config.* Makefile man/Makefile pcrelib/Makefile libidn/Makefile *~
	-$(RM) -rf autom4te*
