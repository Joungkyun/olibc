# $Id: Makefile.in,v 1.39 2011-04-04 12:21:00 oops Exp $
srcdir			= @srcdir@
top_srcdir		= @top_srcdir@
builddir		= @builddir@
top_builddir	= .

build			= @build@
build_cpu		= @build_cpu@
build_vendor	= @build_vendor@
build_os		= @build_os@
host			= @host@
host_cpu		= @host_cpu@
host_vendor		= @host_vendor@

PROG			= @PACKAGE_NAME@
VERSION			= @PACKAGE_VERSION@
SHELL			= @SHELL@
CC				= @CC@ -Wall
CPP				= @CPP@
CFLAGS			= @CFLAGS@
CPPFLAGS		= -I. -Ipcrelib -Ilibidn @CPPFLAGS@
LDFLAGS			= @LDFLAGS@ $(LIBS)
LIBS			= @LIBS@
#
# If you want to view debug messages, use follow macros.
#   -D__OCDEBUG__       print debug messages
#   -D__OCMEMDEBUG__    print memory allocation/free messages
#
DEFS			= -D_REENTRANT @DEFS@ $(CPPFLAGS)
#DEFS			+= -D__OCDEBUG__ -D__OCMEMDEBUG__
SRC				= $(wildcard *.c)
OBJECT			= $(SRC:.c=.lo)

PCRESRC			:= $(wildcard pcrelib/*.c)
PCREOBJ			= $(PCRESRC:.c=.lo)
IDNSRC			:= $(wildcard libidn/*.c)
IDNOBJ			= $(IDNSRC:.c=.lo)

BPLOBJ			= libmisc.lo libstring.lo libfile.lo libtime.lo libarg.lo libpcre.lo
#GPLOBJ			= _race.lo libidn.lo
GPLOBJ			= libidn.lo
HEADER_NAME		= oc_type libfile libpcre libstring libtime libarg libidn

SONAME_MAJOR	= @SONAME_MAJOR@
SONAME_MINOR	= @SONAME_MINOR@
SONAME_REVISION	= @SONAME_REVISION@
SONAME_INFO		= @SONAME_INFO@
SONAME_VERSION	= @SONAME_VERSION@

prefix			= @prefix@
exec_prefix		= @exec_prefix@
datadir			= @datadir@
includedir		= @includedir@
libdir			= @libdir@
bindir			= @bindir@
DESTDIR			=

LIBTOOL			= @LIBTOOL@
INSTALL			= @INSTALL@
RM				= @RM@ -f
#MAKE			= @MAKE@
MKDIR			= @MKDIR@ -p
STRIP			= @STRIP@
LN				= @LN_S@
MV				= @MV@
PERL			= @PERL@

CC_OPT			= $(CC) $(CFLAGS)
LINK			= $(LIBTOOL) --mode=link $(CC_OPT) 
LINK			+= -rpath $(libdir) -version-info $(SONAME_INFO)
COMPILE			= $(LIBTOOL) --mode=compile $(CC_OPT) $(DEFS) -prefer-pic
P_LIBTOOL		= $(LIBTOOL) --mode=install @INSTALL_PROGRAM@ -m755
D_LIBTOOL		= $(LIBTOOL) --mode=install @INSTALL_DATA@
L_LIBTOOL		= $(LIBTOOL) --mode=install $(INSTALL)
INSTALL_SCRIPT	= @INSTALL_SCRIPT@

%.lo: %.c olibc-config.h oc_common.h
	$(COMPILE) -o $@ -c $<

all: prepare pcre idn $(OBJECT) libs olibc-config

prepare:
	if test ! -d "olibc"; then \
		$(MKDIR) olibc; \
		cd olibc; \
		ln -sf ../*.h ./; \
		cd -; \
	fi

pcre:
	$(MAKE) -C pcrelib

idn:
	$(MAKE) -C libidn

libs:
	$(LINK) -o lib$(PROG).la $(OBJECT) $(PCREOBJ) $(IDNOBJ) $(LDFLAGS)
	$(LINK) -o liboc.la $(BPLOBJ) $(PCREOBJ) $(LDFLAGS)
	$(LINK) -o libogc.la $(GPLOBJ) $(IDNOBJ) $(LDFLAGS) -loc

olibc-config:
	for i in olibc ogc oc ; do \
		$(INSTALL) olibc-config.in $$i-config ; \
		$(PERL) -pi -e "s!\@prefix\@!$(prefix)!g" $$i-config ; \
		$(PERL) -pi -e "s!\@exec_prefix\@!$(exec_prefix)!g" $$i-config ; \
		$(PERL) -pi -e "s!\@VERSION\@!$(VERSION)!g" $$i-config ; \
		$(PERL) -pi -e "s!\@includedir\@!$(includedir)!g" $$i-config ; \
		$(PERL) -pi -e "s!\@libdir\@!$(libdir)!g" $$i-config ; \
		$(PERL) -pi -e "s!\@CFLAGS\@!$(CFLAGS)!g" $$i-config ; \
		$(PERL) -pi -e "s!\@prog\@!$$i!g" $$i-config ; \
	done

install: install-doc install-header
	$(MKDIR) $(DESTDIR)$(bindir)
	$(MKDIR) $(DESTDIR)$(libdir)
	for i in olibc oc ogc ; do \
		$(P_LIBTOOL) $$i-config $(DESTDIR)$(bindir) ; \
		$(L_LIBTOOL) lib$$i.la $(DESTDIR)$(libdir)/lib$$i.la ; \
		$(LIBTOOL) --finish $(libdir) ; \
	done

install-header:
	$(MKDIR) $(DESTDIR)$(includedir)
	for i in $(HEADER_NAME) ; do \
		$(D_LIBTOOL) $$i.h $(DESTDIR)$(includedir)/ ; \
	done

install-doc:
	$(MAKE) -C man install

test:
	$(MAKE) -C sample
	$(MAKE) -C sample confirm

clean:
	$(MAKE) -C pcrelib clean
	$(MAKE) -C libidn clean
	$(MAKE) -C sample clean
	-$(RM) -f *.o *.lo *.la *.so* *.a main olibc-config .libs/* *-config

distclean: clean
	-$(RM) -f olibc-config.h config.log config.status Makefile
	-$(RM) -f man/Makefile pcrelib/Makefile pcrelib/config.h
	-$(RM) -f oc_type.h libidn/config.h libidn/Makefile *~
	-$(RM) -rf autom4te* libidn/idn-int.h stamp* .libs libtool
	-$(RM) -rf libidn/.libs pcrelib/.libs olibc sample/Makefile
