/** 
 * @file	oc_type.h
 * @brief	Common header file
 *
 * This file includes common header files and declare
 * data structures, and defination macro.
 *
 * @author	JoungKyun.Kim <http://oops.org>
 * $Date$
 * $Revision$
 * @attention	Copyright (c) 2011 JoungKyun.Kim all rights reserved.
 */
/* $Id$ */

#ifndef OC_TYPE_H
#define OC_TYPE_H

#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <limits.h>

/************ architecure **********/
#if defined(__x86_64) || defined(__amd64)
	#ifndef __x86_64__
		#define __x86_64__  1
	#endif
#endif
/************ architecure **********/

#ifndef null
#define null NULL
#endif

#ifndef OLIBC_CONFIG_H
	/* The size of a `long', as computed by sizeof. */
	#undef SIZEOF_LONG

	/* Define to 1 if you have the <stdbool.h> header file. */
	#undef HAVE_STDBOOL_H
#endif

typedef unsigned char UChar;        //!< unsigned char
typedef const char CChar;           //!< const char
typedef const unsigned char UCChar; //!< const unsigned char
typedef unsigned short UShort;      //!< unsigned short
typedef unsigned int UInt;          //!< unsigned int

#if SIZEOF_LONG == 4
typedef long Long;                  //!< 4byte(32bit) integer
typedef long Long32;                //!< 4byte(32bit) integer
typedef long long Long64;           //!< 8byte(64bit) integer
typedef unsigned long ULong;        //!< 4byte(32bit) unsigned integer
typedef unsigned long ULong32;      //!< 4byte(32bit) unsigned integer
typedef unsigned long long ULong64; //!< 8byte(64bit) unsigned integer
#else
typedef int Long;                   //!< 4byte(32bit) integer
typedef int Long32;                 //!< 4byte(32bit) integer
typedef long Long64;                //!< 8byte(64bit) integer
typedef unsigned int ULong;         //!< 4byte(32bit) unsigned integer
typedef unsigned int ULong32;       //!< 4byte(32bit) unsigned integer
typedef unsigned long ULong64;      //!< 8byte(64bit) unsigned integer
#endif

//! 64bit integer structure on 32bit
typedef struct {
	ULong32 high;                   //!< high 32bit of 64bit ingeger
	ULong32 low;                    //!< low 32bit of 64bit ingeger
} Bit64;

#ifdef HAVE_STDBOOL_H
	#include <stdbool.h>
#else
	#define _STDBOOL_H
	#ifndef __cplusplus

		#define bool    _Bool
		#define true    1
		#define false   0

	#else /* __cplusplus */

		#define _Bool   bool
		#define bool    bool
		#define false   false
		#define true    true

	#endif
	/* Signal that all the definitions are present.  */
	#define __bool_true_false_are_defined   1
#endif

/*
 * Definition about memory api
 */

#define oc_error_debug(...) \
	{ \
		fprintf (stderr, "DEBUG: %s(%s:%d): ", __func__, __FILE__, __LINE__); \
		fprintf (stderr, __VA_ARGS__); \
	};

#ifdef __OCDEBUG__
	#define OC_DEBUG(...) oc_error_debug (__VA_ARGS__)
	#define oc_error(...) oc_error_debug ( __VA_ARGS__)
#else
	#define OC_DEBUG(...)
	#define oc_error(...) \
		{ \
			fprintf (stderr, "OC ERROR: "); \
			fprintf (stderr, __VA_ARGS__); \
		}
#endif

#ifdef __OCMEMDEBUG__
	#define OC_MEM_DEBUG(...) oc_error_debug (__VA_ARGS__)
#else
	#define OC_MEM_DEBUG(...)
#endif

#define ofree(v) \
	{ \
		OC_MEM_DEBUG ("Memory free%s\n", v == NULL ? ": NULL" : ""); \
		if ( v != NULL ) { \
			free (v); \
			v = NULL; \
		} \
	}

#define oc_malloc(v, size) \
	{ \
		OC_MEM_DEBUG("Memory allocation\n"); \
		v = malloc (size); \
	}
	
#define oc_realloc(v, size) \
	{ \
		void * ptr; \
		OC_MEM_DEBUG("Memory reallocation\n"); \
		if ( (ptr = realloc (v, size)) == NULL ) { \
			ofree (v); \
			v = NULL; \
		} else { \
			v = ptr; \
		} \
	}

#define oc_strdup(v, val, size) \
	{ \
		OC_DEBUG ("strdup add size : %d + %d\n", size, (size < 4) ? 4 : 1); \
		oc_malloc(v, size + ((size < 4) ? 4 : 1)); \
		if ( v != NULL ) { \
			memcpy (v, val, size); \
			memset (v + size, 0, 1); \
		} \
	}

#define OC_DEF_EXIT    0
#define OC_DEF_RETURN  1
#define OC_DEF_MALLOC  0
#define OC_DEF_REALLOC 1

#define oc_malloc_originate(type, v, size, ret, result) \
	{ \
		if ( type == OC_DEF_REALLOC ) { oc_realloc (v, size); } \
		else { oc_malloc (v, size); } \
		if ( v == NULL ) { \
			oc_error ("%s: memory %sallocation failed\n", __func__, type ? "re" : ""); \
			if ( result == OC_DEF_RETURN ) return ret; \
			exit (1); \
		} \
		if ( type == OC_DEF_MALLOC ) { memset (v, 0, size); } \
	}

/*
 * v -> allocated variable
 * size -> allocated size
 * ret -> if failed allocat, return value
 */
#define oc_malloc_r(v, size, ret) \
	oc_malloc_originate (OC_DEF_MALLOC, v, size, ret, OC_DEF_RETURN)

#define oc_realloc_r(v, size, ret) \
	oc_malloc_originate (OC_DEF_REALLOC, v, size, ret, OC_DEF_RETURN)

#define oc_malloc_die(v, size) \
	oc_malloc_originate (OC_DEF_MALLOC, v, size, ret, OC_DEF_EXIT)

#define oc_realloc_die(v, size) \
	oc_malloc_originate (OC_DEF_REALLOC, v, size, ret, OC_DEF_EXIT)

#define oc_strdup_originate(v, data, ret, result) \
	{ \
		oc_strdup (v, data, strlen (data)); \
		if ( v == NULL ) { \
			if ( result == OC_DEF_RETURN ) \
				return ret; \
			exit (1); \
		} \
	}

#define oc_strdup_r(v, data, ret) \
		 oc_strdup_originate (v, data, ret, OC_DEF_RETURN)

#define oc_strdup_e(v, data, ret) \
		 oc_strdup_originate (v, data, ret, OC_DEF_EXIT)


#define oc_safe_cpy(dst, src, size) \
	{ \
		UInt cpylen; \
		cpylen = strlen (src); \
		cpylen = (cpylen > (size-1)) ? size - 1 : cpylen; \
		memmove (dst, src, cpylen); \
		memset (dst + cpylen, 0, 1); \
	}

#endif
